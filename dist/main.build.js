!function(e){var t={};function s(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(n,i,function(t){return e[t]}.bind(null,i));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=2)}([function(e,t,s){},function(e,t){},function(e,t,s){"use strict";s.r(t);s(0),s(1);class n{constructor(e,t){this.element=e,this.onLogin=t;document.querySelector("[data-role=login-nickname-input]");const s=document.querySelector("[data-role=login-nickname-input]"),n=document.querySelector("[data-role=login-submit]"),i=document.querySelector("[data-role=login-error]");console.log(i),n.addEventListener("click",()=>{console.log("click"),i.textContent="";const e=s.value.trim();e?this.onLogin(e):i.textContent="Введите Nickname!"})}show(){this.element.classList.remove("hidden")}hide(){this.element.classList.add("hidden")}}class i{constructor(e){this.element=e}show(){this.element.classList.remove("hidden")}hide(){this.element.classList.add("hidden")}}class o{constructor(e){this.element=e,this.items=new Set,console.log(this.element)}buildDOM(){const e=document.createDocumentFragment();this.element.innerHTML="";for(const t of this.items){const s=document.createElement("div");s.classList.add("user-list-item"),s.textContent=t,e.append(s)}this.element.append(e)}add(e){this.items.add(e),this.buildDOM()}remove(e){this.items.delete(e),this.buildDOM()}}class a{constructor(e){this.element=e}set(e){this.name=e,this.element.textContent=e}get(){return this.name}}class r{constructor(e,t){this.element=e,this.onUpload=t,this.element.addEventListener("dragover",e=>{e.dataTransfer.items.length&&"file"===e.dataTransfer.items[0].kind&&e.preventDefault()}),console.log(this.element),this.element.addEventListener("drop",e=>{e.preventDefault();const t=e.dataTransfer.items[0].getAsFile(),s=new FileReader;s.readAsDataURL(t),console.log(t),s.addEventListener("load",()=>this.onUpload(s.result))})}set(e){this.element.style.backgroundImage=`url(${e})`}}const l=/<|>\/|'|\u2028|\u2029/g,d={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"\\u0027;","</":"\\u002F","\u2028":"\\u2028","\u2029":"\\u2029"},u=e=>d[e];function c(e){return e.replace(l,u)}class m{constructor(e){this.element=e}add(e,t){const s=new Date,n=`${String(s.getHours()).padStart(2,0)}:${String(s.getMinutes()).padStart(2,0)}`,i=document.createElement("div");i.classList.add("message-item"),i.innerHTML=`\n        <div class="message-item-left">\n            <div class="message-item-photo" data-role="user-avatar" data-user=${c(e)} style="background-image: url(/img/upload-photo/${e}.png?t=${Date.now()})"></div>\n        </div>\n        <div class="message-item-right">\n            <div class="message-item-header">\n                <div class="message-item-header-name">${c(e)}</div>\n                <div class="message-item-header-time">${n}</div>\n            </div>\n            <div class="message-item-text">${c(t)}</div>\n        </div>\n        `,this.element.append(i),this.element.scrollTop=this.element.scrollHeight}addSystemMessage(e){const t=document.createElement("div");t.classList.add("message-item","message-item-system"),t.textContent=e,this.element.append(t),this.element.scrollTop=this.element.scrollHeight}}class h{constructor(e,t){this.onSend=t,this.messageInput=document.querySelector("[data-role=message-input]"),this.messageSendButton=document.querySelector("[data-role=message-send]"),this.messageSendButton.addEventListener("click",()=>{const e=this.messageInput.value.trim();e&&this.onSend(e)})}clear(){this.messageInput.value=""}}class g{constructor(e,t){this.url=e,this.onMessage=t}connect(){return new Promise(e=>{this.socket=new WebSocket(this.url),this.socket.addEventListener("open",e),this.socket.addEventListener("message",e=>{this.onMessage(JSON.parse(e.data))})})}sendHello(e){this.sendMessage("hello",{name:e})}sendTextMessage(e){this.sendMessage("message",{message:e})}sendMessage(e,t){this.socket.send(JSON.stringify({type:e,data:t}))}}new class{constructor(){this.wsClient=new g("ws://localhost:1234",this.onMessage.bind(this)),this.ui={loginWindow:new n(document.querySelector("#loginWindow"),this.onLogin.bind(this)),mainWindow:new i(document.querySelector("#mainChat"),this.onLogin.bind(this)),userName:new a(document.querySelector("[data-role=user-name]"),this.onLogin.bind(this)),userList:new o(document.querySelector("[data-role=user-list]")),messageList:new m(document.querySelector("[data-role=message-list]")),messageSender:new h(document.querySelector("[data-role=message-sender]"),this.onSend.bind(this)),userPhoto:new r(document.querySelector("[data-role=user-photo]"),this.onUpload.bind(this))},console.log(document.querySelector("[data-role=user-list]")),this.ui.loginWindow.show()}onUpload(e){this.ui.userPhoto.set(e),fetch("img/upload-photo",{method:"post",body:JSON.stringify({name:this.ui.userName.get(),image:e})})}async onLogin(e){await this.wsClient.connect(),this.wsClient.sendHello(e),this.ui.loginWindow.hide(),this.ui.mainWindow.show(),this.ui.userName.set(e)}onMessage({type:e,from:t,data:s}){if(console.log(e,t,s),"hello"===e)this.ui.userList.add(t),this.ui.messageList.addSystemMessage(t+" вошел в чат");else if("user-list"===e)for(const e of s)this.ui.userList.add(e);else if("bye-bye"===e)this.ui.userList.remove(t),this.ui.messageList.addSystemMessage(t+" вышел из чата");else if("message"===e)this.ui.messageList.add(t,s.message);else if("photo-changed"===e){const e=document.querySelectorAll(`[data-role=user-avatar][data-user=${s.name}]`);for(const t of e)t.style.backgroundImage=`url(/img/upload-photo/${s.name}\n                    .png?t=${Data.now()})`}}onSend(e){this.wsClient.sendTextMessage(e),this.ui.messageSender.clear()}}}]);